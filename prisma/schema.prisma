// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserPlan {
  FREE
  PRO
  ENTERPRISE
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  UNPAID
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

model User {
  id                     String      @id @default(uuid())
  email                  String      @unique
  passwordHash           String      @map("password_hash")
  name                   String
  plan                   UserPlan    @default(FREE)
  status                 UserStatus  @default(ACTIVE)
  isAdmin                Boolean     @default(false) @map("is_admin")
  dodoCustomerId         String?     @unique @map("dodo_customer_id") // Dodo Payments customer ID
  emailVerified          Boolean     @default(false) @map("email_verified")
  emailVerificationToken String?     @unique @map("email_verification_token")
  emailVerificationExpiry DateTime?  @map("email_verification_expiry")
  passwordResetToken     String?     @unique @map("password_reset_token")
  passwordResetExpiry    DateTime?   @map("password_reset_expiry")
  lastLoginAt            DateTime?   @map("last_login_at")
  createdAt              DateTime    @default(now()) @map("created_at")
  updatedAt              DateTime    @updatedAt @map("updated_at")

  apiKeys       ApiKey[]
  usageLogs     UsageLog[]
  quotas        Quota[]
  webhooks      Webhook[]
  subscriptions Subscription[]
  payments      Payment[]
  auditLogs     AuditLog[]

  @@map("users")
}

model ApiKey {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  key         String    @unique // This will store the hashed API key
  name        String    // User-defined label for the key
  lastUsedAt  DateTime? @map("last_used_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  revokedAt   DateTime? @map("revoked_at")

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  usageLogs   UsageLog[]

  @@index([userId])
  @@index([key])
  @@map("api_keys")
}

model UsageLog {
  id               String   @id @default(uuid())
  apiKeyId         String   @map("api_key_id")
  userId           String   @map("user_id")
  endpoint         String
  urlRequested     String?  @map("url_requested")
  statusCode       Int      @map("status_code")
  responseTimeMs   Int      @map("response_time_ms")
  errorMessage     String?  @map("error_message")
  createdAt        DateTime @default(now()) @map("created_at")

  apiKey           ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([apiKeyId])
  @@index([createdAt])
  @@map("usage_logs")
}

model Quota {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  periodStart    DateTime @map("period_start")
  periodEnd      DateTime @map("period_end")
  requestsMade   Int      @default(0) @map("requests_made")
  requestsLimit  Int      @map("requests_limit")
  createdAt      DateTime @default(now()) @map("created_at")

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([periodStart, periodEnd])
  @@map("quotas")
}

model Webhook {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  url            String
  events         String[]  // Array of event types to listen to
  secret         String    // For webhook signature verification
  isActive       Boolean   @default(true) @map("is_active")
  lastTriggeredAt DateTime? @map("last_triggered_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("webhooks")
}

model Subscription {
  id                   String             @id @default(uuid())
  userId               String             @map("user_id")
  dodoSubscriptionId   String             @unique @map("dodo_subscription_id") // Dodo Payments subscription ID
  dodoCustomerId       String             @map("dodo_customer_id")
  plan                 UserPlan
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime           @map("current_period_start")
  currentPeriodEnd     DateTime           @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  canceledAt           DateTime?          @map("canceled_at")
  trialStart           DateTime?          @map("trial_start")
  trialEnd             DateTime?          @map("trial_end")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments             Payment[]

  @@index([userId])
  @@index([dodoSubscriptionId])
  @@index([status])
  @@map("subscriptions")
}

model Payment {
  id                 String        @id @default(uuid())
  userId             String        @map("user_id")
  subscriptionId     String?       @map("subscription_id")
  dodoPaymentId      String        @unique @map("dodo_payment_id") // Dodo Payments payment ID
  dodoInvoiceId      String?       @map("dodo_invoice_id")
  amount             Int           // Amount in cents
  currency           String        @default("USD")
  status             PaymentStatus @default(PENDING)
  plan               UserPlan
  description        String?
  receiptUrl         String?       @map("receipt_url")
  failureReason      String?       @map("failure_reason")
  paidAt             DateTime?     @map("paid_at")
  refundedAt         DateTime?     @map("refunded_at")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription       Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  action      String   // e.g., "user.login", "user.register", "subscription.created"
  resource    String?  // e.g., "user", "subscription", "api_key"
  resourceId  String?  @map("resource_id")
  details     String?  @db.Text // JSON string with additional details
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
