// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                   String                @id
  name                 String
  email                String
  emailVerified        Boolean               @default(false)
  image                String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  sessions             Session[]
  accounts             Account[]
  members              Member[]
  invitations          Invitation[]
  webhooks             Webhook[]
  auditLogs            AuditLog[]
  screenshots          Screenshot[]
  scheduledScreenshots ScheduledScreenshot[]

  @@unique([email])
  @@map("user")
}

model Session {
  id                   String   @id
  expiresAt            DateTime
  token                String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  ipAddress            String?
  userAgent            String?
  userId               String
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activeOrganizationId String?

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Organization {
  id          String       @id
  name        String
  slug        String
  logo        String?
  createdAt   DateTime
  metadata    String?
  members     Member[]
  invitations Invitation[]

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String       @default("member")
  createdAt      DateTime

  @@index([organizationId])
  @@index([userId])
  @@map("member")
}

model Invitation {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String       @default("pending")
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@map("invitation")
}

model Webhook {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  url             String
  events          String[] // Array of event types to listen to
  secret          String // For webhook signature verification
  isActive        Boolean   @default(true) @map("is_active")
  lastTriggeredAt DateTime? @map("last_triggered_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("webhooks")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String // e.g., "user.login", "user.register", "subscription.created"
  resource   String? // e.g., "user", "subscription", "api_key"
  resourceId String?  @map("resource_id")
  details    String?  @db.Text // JSON string with additional details
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model Screenshot {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  url       String // The URL that was screenshotted
  imageData Bytes     @map("image_data") // Binary screenshot data
  format    String    @default("png") // png or jpeg
  fileSize  Int       @map("file_size") // Size in bytes
  metadata  String?   @db.Text // JSON with screenshot options (viewport, device, etc.)
  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime? @map("expires_at") // Optional expiration date

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("screenshots")
}

model ScheduledScreenshot {
  id                String    @id @default(uuid())
  userId            String    @map("user_id")
  name              String // User-friendly name for this schedule
  url               String // The URL to screenshot
  cronExpression    String    @map("cron_expression") // Cron expression (e.g., "0 0 * * *")
  options           String?   @db.Text // JSON with screenshot options
  isActive          Boolean   @default(true) @map("is_active")
  saveHistory       Boolean   @default(true) @map("save_history") // Save screenshots to history
  webhookOnComplete Boolean   @default(false) @map("webhook_on_complete") // Trigger webhook on completion
  lastRunAt         DateTime? @map("last_run_at")
  nextRunAt         DateTime? @map("next_run_at")
  runCount          Int       @default(0) @map("run_count")
  failureCount      Int       @default(0) @map("failure_count")
  lastError         String?   @map("last_error")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@index([nextRunAt])
  @@map("scheduled_screenshots")
}
