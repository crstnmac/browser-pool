// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserPlan {
  FREE
  PRO
  ENTERPRISE
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

model User {
  id            String      @id @default(uuid())
  email         String      @unique
  passwordHash  String      @map("password_hash")
  name          String
  plan          UserPlan    @default(FREE)
  status        UserStatus  @default(ACTIVE)
  isAdmin       Boolean     @default(false) @map("is_admin")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  apiKeys       ApiKey[]
  usageLogs     UsageLog[]
  quotas        Quota[]
  webhooks      Webhook[]

  @@map("users")
}

model ApiKey {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  key         String    @unique // This will store the hashed API key
  name        String    // User-defined label for the key
  lastUsedAt  DateTime? @map("last_used_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  revokedAt   DateTime? @map("revoked_at")

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  usageLogs   UsageLog[]

  @@index([userId])
  @@index([key])
  @@map("api_keys")
}

model UsageLog {
  id               String   @id @default(uuid())
  apiKeyId         String   @map("api_key_id")
  userId           String   @map("user_id")
  endpoint         String
  urlRequested     String?  @map("url_requested")
  statusCode       Int      @map("status_code")
  responseTimeMs   Int      @map("response_time_ms")
  errorMessage     String?  @map("error_message")
  createdAt        DateTime @default(now()) @map("created_at")

  apiKey           ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([apiKeyId])
  @@index([createdAt])
  @@map("usage_logs")
}

model Quota {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  periodStart    DateTime @map("period_start")
  periodEnd      DateTime @map("period_end")
  requestsMade   Int      @default(0) @map("requests_made")
  requestsLimit  Int      @map("requests_limit")
  createdAt      DateTime @default(now()) @map("created_at")

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([periodStart, periodEnd])
  @@map("quotas")
}

model Webhook {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  url            String
  events         String[]  // Array of event types to listen to
  secret         String    // For webhook signature verification
  isActive       Boolean   @default(true) @map("is_active")
  lastTriggeredAt DateTime? @map("last_triggered_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("webhooks")
}
